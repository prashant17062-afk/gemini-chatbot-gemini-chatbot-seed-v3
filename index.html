<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemini 1.5 Flash Exp Chatbot</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; padding: 0; background-color: #f0f2f5; color: #333; display: flex; flex-direction: column; min-height: 100vh; }
        #app { max-width: 800px; margin: 20px auto; background-color: #fff; border-radius: 8px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); display: flex; flex-direction: column; overflow: hidden; flex-grow: 1; }
        h1 { text-align: center; color: #1a73e8; padding: 20px; border-bottom: 1px solid #eee; margin: 0; }
        #settings-panel { padding: 15px 20px; background-color: #f9f9f9; border-bottom: 1px solid #eee; }
        #settings-panel summary { font-weight: bold; cursor: pointer; color: #1a73e8; list-style: none; }
        #settings-panel summary::-webkit-details-marker { display: none; }
        #settings-panel summary::before { content: '▶'; display: inline-block; width: 1.2em; transition: transform 0.2s ease; }
        #settings-panel[open] summary::before { content: '▼'; transform: rotate(90deg); }
        #settings-panel div { padding-top: 10px; }
        #settings-panel label { display: block; margin-bottom: 5px; font-weight: 500; }
        #settings-panel input[type="password"], #settings-panel textarea, #settings-panel input[type="number"], #settings-panel input[type="range"] {
            width: calc(100% - 20px); padding: 8px 10px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box;
        }
        #settings-panel textarea { resize: vertical; min-height: 60px; }
        #settings-panel input[type="checkbox"] { margin-right: 5px; }
        .chat-management { padding: 10px 20px; background-color: #f0f2f5; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .chat-management button { padding: 8px 15px; border: none; border-radius: 4px; cursor: pointer; background-color: #1a73e8; color: white; font-size: 0.9em; transition: background-color 0.2s ease; }
        .chat-management button:hover { background-color: #155bb5; }
        #message-count { font-size: 0.9em; color: #555; }
        #chat-history { flex-grow: 1; padding: 20px; overflow-y: auto; background-color: #fdfdfd; border-bottom: 1px solid #eee; }
        .message { margin-bottom: 15px; padding: 10px 15px; border-radius: 6px; position: relative; display: flex; flex-direction: column; }
        .message.user { background-color: #e6f3ff; align-self: flex-end; margin-left: auto; text-align: right; border-bottom-right-radius: 0; }
        .message.model { background-color: #f0f0f0; align-self: flex-start; margin-right: auto; border-bottom-left-radius: 0; }
        .message-content { word-wrap: break-word; white-space: pre-wrap; margin-bottom: 5px; }
        .message-footer { font-size: 0.75em; color: #777; display: flex; align-items: center; justify-content: flex-end; gap: 8px; }
        .message.model .message-footer { justify-content: flex-start; }
        .copy-btn { background-color: #ccc; color: #333; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 0.7em; transition: background-color 0.2s ease; }
        .copy-btn:hover { background-color: #bbb; }
        .user-input-area { padding: 15px 20px; background-color: #f9f9f9; border-top: 1px solid #eee; display: flex; flex-wrap: wrap; align-items: center; gap: 10px; }
        #user-input { flex-grow: 1; padding: 10px; border: 1px solid #ccc; border-radius: 4px; resize: none; min-height: 40px; box-sizing: border-box; font-size: 1em; }
        #send-btn { background-color: #1a73e8; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; font-size: 1em; transition: background-color 0.2s ease; }
        #send-btn:hover:not(:disabled) { background-color: #155bb5; }
        #send-btn:disabled { background-color: #cccccc; cursor: not-allowed; }
        .input-info { width: 100%; text-align: right; font-size: 0.85em; color: #777; padding-top: 5px; }
        footer { text-align: center; padding: 15px; font-size: 0.8em; color: #777; border-top: 1px solid #eee; margin-top: auto; }
    </style>
</head>
<body>
    <div id="app">
        <h1>Gemini 1.5 Flash Exp Chatbot</h1>

        <details id="settings-panel">
            <summary>Settings</summary>
            <div>
                <label for="api-key">Google Gemini API Key:</label>
                <input type="password" id="api-key" placeholder="Enter your API Key" required>
                <label><input type="checkbox" id="show-api-key"> Show API Key</label>

                <label for="system-prompt">System Prompt:</label>
                <textarea id="system-prompt" rows="3" placeholder="Set a system-level instruction for the AI."></textarea>

                <label for="temperature-slider">Temperature: <span id="temperature-value">1.0</span></label>
                <input type="range" id="temperature-slider" min="0" max="2" step="0.1" value="1.0">

                <label for="max-tokens">Max Output Tokens: <span id="max-tokens-value">1000</span></label>
                <input type="number" id="max-tokens" min="100" max="8192" value="1000">
            </div>
        </details>

        <div class="chat-management">
            <button id="clear-btn">Clear Chat</button>
            <button id="export-btn">Export Chat</button>
            <span id="message-count">Messages: 0</span>
        </div>

        <div id="chat-history">
            <!-- Chat messages will be dynamically added here -->
        </div>

        <div class="user-input-area">
            <textarea id="user-input" placeholder="Type your message..." maxlength="2000"></textarea>
            <button id="send-btn">Send</button>
            <div class="input-info">
                <span id="char-count">Chars: 0/2000</span>
            </div>
        </div>
    </div>

    <footer>
        MIT License
    </footer>

    <script>
        const API_URL = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=';
        const MAX_INPUT_CHARS = 2000;

        const apiKeyInput = document.getElementById('api-key');
        const showApiKeyCheckbox = document.getElementById('show-api-key');
        const systemPromptTextarea = document.getElementById('system-prompt');
        const temperatureSlider = document.getElementById('temperature-slider');
        const temperatureValueSpan = document.getElementById('temperature-value');
        const maxTokensInput = document.getElementById('max-tokens');
        const maxTokensValueSpan = document.getElementById('max-tokens-value');
        const settingsPanel = document.getElementById('settings-panel');

        const chatHistoryDiv = document.getElementById('chat-history');
        const userInput = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-btn');
        const clearBtn = document.getElementById('clear-btn');
        const exportBtn = document.getElementById('export-btn');
        const messageCountSpan = document.getElementById('message-count');
        const charCountSpan = document.getElementById('char-count');

        let chatHistoryArray = []; // Stores { role: 'user' | 'model', text: string, timestamp: string }

        // --- Utility Functions ---
        function getTimestamp() {
            const now = new Date();
            let hours = now.getHours();
            const minutes = now.getMinutes().toString().padStart(2, '0');
            const ampm = hours >= 12 ? 'PM' : 'AM';
            hours = hours % 12;
            hours = hours ? hours : 12; // The hour '0' should be '12'
            return `${hours}:${minutes} ${amppm}`;
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                alert('Message copied to clipboard!');
            }).catch(err => {
                console.error('Failed to copy: ', err);
            });
        }

        function updateCharCount() {
            const currentLength = userInput.value.length;
            charCountSpan.textContent = `Chars: ${currentLength}/${MAX_INPUT_CHARS}`;
            sendBtn.disabled = currentLength === 0 || currentLength > MAX_INPUT_CHARS || apiKeyInput.value.trim() === '';
        }

        function updateMessageCount() {
            messageCountSpan.textContent = `Messages: ${chatHistoryArray.length}`;
        }

        function saveChatHistory() {
            localStorage.setItem('chatHistory', JSON.stringify(chatHistoryArray));
        }

        function loadChatHistory() {
            const storedHistory = localStorage.getItem('chatHistory');
            if (storedHistory) {
                chatHistoryArray = JSON.parse(storedHistory);
                chatHistoryArray.forEach(msg => renderMessage(msg.role, msg.text, msg.timestamp, false)); // Render without saving again
                updateMessageCount();
            }
        }

        function saveSettings() {
            const settings = {
                apiKey: apiKeyInput.value,
                systemPrompt: systemPromptTextarea.value,
                temperature: parseFloat(temperatureSlider.value),
                maxTokens: parseInt(maxTokensInput.value, 10),
                settingsPanelOpen: settingsPanel.open // Save panel state
            };
            localStorage.setItem('chatSettings', JSON.stringify(settings));
        }

        function loadSettings() {
            const storedSettings = localStorage.getItem('chatSettings');
            if (storedSettings) {
                const settings = JSON.parse(storedSettings);
                apiKeyInput.value = settings.apiKey || '';
                systemPromptTextarea.value = settings.systemPrompt || '';
                temperatureSlider.value = settings.temperature !== undefined ? settings.temperature : 1.0;
                temperatureValueSpan.textContent = temperatureSlider.value;
                maxTokensInput.value = settings.maxTokens !== undefined ? settings.maxTokens : 1000;
                maxTokensValueSpan.textContent = maxTokensInput.value;
                settingsPanel.open = settings.settingsPanelOpen !== undefined ? settings.settingsPanelOpen : false;

                // Set API key input type based on stored state or default
                if (showApiKeyCheckbox.checked) {
                    apiKeyInput.type = 'text';
                } else {
                    apiKeyInput.type = 'password';
                }
            } else {
                // Set defaults if no settings are stored
                temperatureSlider.value = 1.0;
                temperatureValueSpan.textContent = '1.0';
                maxTokensInput.value = 1000;
                maxTokensValueSpan.textContent = '1000';
            }
            updateCharCount(); // Update send button state based on loaded API key
        }

        // --- Message Rendering ---
        function renderMessage(role, text, timestamp, shouldSave = true) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message', role);

            const contentDiv = document.createElement('div');
            contentDiv.classList.add('message-content');
            contentDiv.textContent = text;
            messageDiv.appendChild(contentDiv);

            const footerDiv = document.createElement('div');
            footerDiv.classList.add('message-footer');
            const timestampSpan = document.createElement('span');
            timestampSpan.textContent = timestamp;
            footerDiv.appendChild(timestampSpan);

            if (role === 'model') {
                const copyButton = document.createElement('button');
                copyButton.classList.add('copy-btn');
                copyButton.textContent = 'Copy';
                copyButton.onclick = () => copyToClipboard(text);
                footerDiv.appendChild(copyButton);
            }
            messageDiv.appendChild(footerDiv);

            chatHistoryDiv.appendChild(messageDiv);
            chatHistoryDiv.scrollTop = chatHistoryDiv.scrollHeight; // Scroll to bottom

            if (shouldSave) {
                chatHistoryArray.push({ role, text, timestamp });
                saveChatHistory();
                updateMessageCount();
            }
        }

        // --- API Interaction ---
        async function sendMessage() {
            const message = userInput.value.trim();
            const apiKey = apiKeyInput.value.trim();

            if (!apiKey) {
                alert('Please enter your API Key in the settings.');
                apiKeyInput.focus();
                settingsPanel.open = true;
                return;
            }

            if (!message) return;

            renderMessage('user', message, getTimestamp());
            userInput.value = '';
            updateCharCount(); // Disable send button, update char count

            renderMessage('model', 'Generating response...', getTimestamp(), false); // Temporary message

            try {
                const systemPrompt = systemPromptTextarea.value.trim();
                const temperature = parseFloat(temperatureSlider.value);
                const maxTokens = parseInt(maxTokensInput.value, 10);

                const body = {
                    'contents': [{'parts': [{'text': message}]}],
                    'generationConfig': {
                        'temperature': temperature,
                        'maxOutputTokens': maxTokens
                    }
                };

                if (systemPrompt) {
                    body.systemInstruction = {'parts': [{'text': systemPrompt}]};
                }

                const response = await fetch(`${API_URL}${apiKey}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(body)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error ? errorData.error.message : response.statusText);
                }

                const data = await response.json();
                const botReply = data.candidates && data.candidates[0] && data.candidates[0].content && data.candidates[0].content.parts && data.candidates[0].content.parts[0] ? data.candidates[0].content.parts[0].text : 'No response from AI.';

                // Remove temporary "Generating response..." message
                chatHistoryDiv.removeChild(chatHistoryDiv.lastChild);

                renderMessage('model', botReply, getTimestamp());

            } catch (error) {
                console.error('API Error:', error);
                // Remove temporary "Generating response..." message
                chatHistoryDiv.removeChild(chatHistoryDiv.lastChild);
                renderMessage('model', `Error: ${error.message || 'Could not get response from AI.'}`, getTimestamp());
            } finally {
                sendBtn.disabled = false; // Re-enable send button
            }
        }

        // --- Event Listeners ---
        sendBtn.addEventListener('click', sendMessage);
        userInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });
        userInput.addEventListener('input', updateCharCount);

        apiKeyInput.addEventListener('input', saveSettings);
        showApiKeyCheckbox.addEventListener('change', () => {
            apiKeyInput.type = showApiKeyCheckbox.checked ? 'text' : 'password';
            saveSettings();
        });
        systemPromptTextarea.addEventListener('input', saveSettings);
        temperatureSlider.addEventListener('input', () => {
            temperatureValueSpan.textContent = temperatureSlider.value;
            saveSettings();
        });
        maxTokensInput.addEventListener('input', () => {
            maxTokensValueSpan.textContent = maxTokensInput.value;
            saveSettings();
        });
        settingsPanel.addEventListener('toggle', saveSettings);


        clearBtn.addEventListener('click', () => {
            if (confirm('Are you sure you want to clear all chat history? This cannot be undone.')) {
                chatHistoryArray = [];
                chatHistoryDiv.innerHTML = '';
                saveChatHistory();
                updateMessageCount();
            }
        });

        exportBtn.addEventListener('click', () => {
            if (chatHistoryArray.length === 0) {
                alert('No chat history to export.');
                return;
            }
            const dataStr = JSON.stringify(chatHistoryArray, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `gemini_chat_history_${new Date().toISOString().slice(0, 10)}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        });

        // --- Initialization ---
        window.onload = () => {
            loadSettings();
            loadChatHistory();
            updateCharCount(); // Initial char count and button state
        };
    </script>
</body>
</html>