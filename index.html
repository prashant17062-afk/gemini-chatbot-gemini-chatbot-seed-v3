<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemini Flash Exp Chatbot</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f4f7f6;
            color: #333;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }
        .container {
            background-color: #ffffff;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 800px;
            padding: 25px;
            margin-bottom: 20px;
            display: flex;
            flex-direction: column;
        }
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 25px;
            font-size: 2em;
        }
        .api-key-input, .settings-panel-container {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            background-color: #fafafa;
        }
        .api-key-input label, .settings-panel-toggle {
            font-weight: bold;
            color: #555;
            display: block;
            margin-bottom: 8px;
        }
        input[type="text"], input[type="password"], input[type="number"], textarea {
            width: calc(100% - 20px);
            padding: 10px;
            margin-top: 5px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 0.95em;
            box-sizing: border-box;
        }
        textarea {
            resize: vertical;
            min-height: 60px;
        }
        button {
            background-color: #4CAF50;
            color: white;
            padding: 10px 18px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.3s ease;
        }
        button:hover {
            background-color: #45a049;
        }
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        #chat-messages {
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            height: 400px;
            overflow-y: auto;
            margin-bottom: 20px;
            background-color: #fcfcfc;
            display: flex;
            flex-direction: column;
        }
        .message {
            margin-bottom: 12px;
            padding: 10px 15px;
            border-radius: 8px;
            line-height: 1.5;
            word-wrap: break-word;
            max-width: 90%;
            position: relative;
        }
        .user-message {
            background-color: #e6f7ff;
            align-self: flex-end;
            text-align: right;
            border: 1px solid #b3e0ff;
        }
        .bot-message {
            background-color: #f0f0f0;
            align-self: flex-start;
            text-align: left;
            border: 1px solid #e0e0e0;
        }
        .message .timestamp {
            font-size: 0.75em;
            color: #888;
            margin-top: 5px;
            display: block;
        }
        .bot-message .copy-btn {
            background: none;
            border: 1px solid #ccc;
            color: #555;
            padding: 3px 8px;
            font-size: 0.75em;
            border-radius: 4px;
            cursor: pointer;
            position: absolute;
            top: 5px;
            right: 5px;
            transition: background-color 0.2s ease, color 0.2s ease;
        }
        .bot-message .copy-btn:hover {
            background-color: #e0e0e0;
            color: #333;
        }
        .user-input-area {
            display: flex;
            align-items: flex-end;
            gap: 10px;
            margin-top: 10px;
        }
        #user-input {
            flex-grow: 1;
            min-height: 40px;
            max-height: 150px;
            padding-right: 60px; /* Space for char counter */
        }
        #char-count {
            position: absolute;
            bottom: 15px;
            right: 15px;
            font-size: 0.8em;
            color: #888;
        }
        .input-wrapper {
            position: relative;
            flex-grow: 1;
        }

        .settings-panel-toggle {
            cursor: pointer;
            background-color: #e9ecef;
            padding: 10px 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: #333;
            transition: background-color 0.3s ease;
        }
        .settings-panel-toggle:hover {
            background-color: #dee2e6;
        }
        #settings-panel {
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            background-color: #fafafa;
            margin-bottom: 20px;
        }
        #settings-panel label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #555;
        }
        #settings-panel .setting-item {
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px dashed #eee;
        }
        #settings-panel .setting-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        #settings-panel input[type="range"] {
            width: calc(100% - 60px);
            vertical-align: middle;
            margin-right: 10px;
        }
        #settings-panel #temperature-value, #settings-panel #max-tokens {
            vertical-align: middle;
            font-weight: normal;
        }
        #settings-panel #max-tokens {
            width: 80px;
            display: inline-block;
        }
        .checkbox-container {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .checkbox-container input {
            width: auto;
            margin-top: 0;
        }

        .chat-management-panel {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 10px 15px;
            background-color: #e6f7ff;
            border: 1px solid #b3e0ff;
            border-radius: 8px;
        }
        .chat-management-panel #message-count {
            font-weight: bold;
            color: #2c3e50;
        }
        .chat-management-panel button {
            background-color: #007bff;
            margin-left: 10px;
        }
        .chat-management-panel button:hover {
            background-color: #0056b3;
        }
        #clear-btn {
            background-color: #dc3545;
        }
        #clear-btn:hover {
            background-color: #c82333;
        }

        #license-footer {
            margin-top: 30px;
            font-size: 0.8em;
            color: #777;
            text-align: center;
            width: 100%;
            max-width: 800px;
            padding-top: 15px;
            border-top: 1px solid #eee;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Gemini Flash Exp Chatbot</h1>

        <div class="api-key-input">
            <label for="api-key">Gemini API Key:</label>
            <input type="password" id="api-key" placeholder="Enter your Gemini API Key here">
            <div class="checkbox-container" style="margin-top: 10px;">
                <input type="checkbox" id="show-api-key">
                <label for="show-api-key" style="margin-bottom: 0;">Show API Key</label>
            </div>
        </div>

        <div id="settings-panel-toggle" class="settings-panel-toggle">
            Settings <span id="toggle-icon">&#9660;</span>
        </div>

        <div id="settings-panel" style="display: none;">
            <div class="setting-item">
                <label for="system-prompt">System Prompt:</label>
                <textarea id="system-prompt" placeholder="Define the chatbot's persona or instructions (e.g., 'You are a helpful academic assistant.')"></textarea>
            </div>

            <div class="setting-item">
                <label for="temperature-slider">Temperature: <span id="temperature-value">1.0</span></label>
                <input type="range" id="temperature-slider" min="0" max="2" step="0.1" value="1.0">
            </div>

            <div class="setting-item">
                <label for="max-tokens">Max Output Tokens: </label>
                <input type="number" id="max-tokens" min="100" max="8192" value="1000">
            </div>
        </div>

        <div id="chat-messages">
            <!-- Chat messages will be appended here -->
        </div>

        <div class="chat-management-panel">
            <span id="message-count">Messages: 0</span>
            <div>
                <button id="clear-btn">Clear Chat</button>
                <button id="export-btn">Export Chat</button>
            </div>
        </div>

        <div class="user-input-area">
            <div class="input-wrapper">
                <textarea id="user-input" placeholder="Type your message..." maxlength="2000"></textarea>
                <span id="char-count">2000</span>
            </div>
            <button id="send-btn">Send</button>
        </div>
    </div>

    <div id="license-footer">
        MIT License
        <br>
        Copyright (c) 2023-2024 Your Name/Organization
        <br>
        Permission is hereby granted, free of charge, to any person obtaining a copy
        of this software and associated documentation files (the "Software"), to deal
        in the Software without restriction, including without limitation the rights
        to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
        copies of the Software, and to permit persons to whom the Software is
        furnished to do so, subject to the following conditions:
        <br>
        The above copyright notice and this permission notice shall be included in all
        copies or substantial portions of the Software.
        <br>
        THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
        IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
        FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
        AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
        LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
        OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
        SOFTWARE.
    </div>

    <script>
        // DOM Elements
        const apiKeyInput = document.getElementById('api-key');
        const showApiKeyCheckbox = document.getElementById('show-api-key');
        const systemPromptTextarea = document.getElementById('system-prompt');
        const temperatureSlider = document.getElementById('temperature-slider');
        const temperatureValueSpan = document.getElementById('temperature-value');
        const maxTokensInput = document.getElementById('max-tokens');
        const chatMessagesDiv = document.getElementById('chat-messages');
        const userInputTextarea = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-btn');
        const charCountSpan = document.getElementById('char-count');
        const messageCountSpan = document.getElementById('message-count');
        const clearChatBtn = document.getElementById('clear-btn');
        const exportChatBtn = document.getElementById('export-btn');
        const settingsPanelToggle = document.getElementById('settings-panel-toggle');
        const settingsPanel = document.getElementById('settings-panel');
        const toggleIcon = document.getElementById('toggle-icon');

        // Global Variables
        let chatHistory = []; // Stores objects { type: 'user'|'bot', text: 'message', timestamp: 'HH:MM AM/PM' }
        const MAX_USER_INPUT_CHARS = 2000;
        const GEMINI_API_URL = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent';

        // --- Utility Functions ---

        /**
         * Formats a Date object into HH:MM AM/PM.
         * @param {Date} date The date object to format.
         * @returns {string} The formatted time string.
         */
        function formatTime(date) {
            let hours = date.getHours();
            let minutes = date.getMinutes();
            const ampm = hours >= 12 ? 'PM' : 'AM';
            hours = hours % 12;
            hours = hours ? hours : 12; // The hour '0' should be '12'
            minutes = minutes < 10 ? '0' + minutes : minutes;
            return `${hours}:${minutes} ${ampm}`;
        }

        /**
         * Copies text to the clipboard.
         * @param {string} text The text to copy.
         */
        async function copyTextToClipboard(text) {
            try {
                await navigator.clipboard.writeText(text);
                alert('Message copied to clipboard!');
            } catch (err) {
                console.error('Failed to copy: ', err);
                alert('Failed to copy message. Please try again.');
            }
        }

        // --- Persistence Functions ---

        /**
         * Saves current settings to localStorage.
         */
        function saveSettings() {
            localStorage.setItem('geminiApiKey', apiKeyInput.value);
            const settings = {
                systemPrompt: systemPromptTextarea.value,
                temperature: parseFloat(temperatureSlider.value),
                maxTokens: parseInt(maxTokensInput.value)
            };
            localStorage.setItem('chatSettings', JSON.stringify(settings));
        }

        /**
         * Loads settings from localStorage and applies them to the UI.
         */
        function loadSettings() {
            apiKeyInput.value = localStorage.getItem('geminiApiKey') || '';

            const storedSettings = JSON.parse(localStorage.getItem('chatSettings')) || {};
            systemPromptTextarea.value = storedSettings.systemPrompt || '';
            temperatureSlider.value = storedSettings.temperature !== undefined ? storedSettings.temperature : 1.0;
            maxTokensInput.value = storedSettings.maxTokens !== undefined ? storedSettings.maxTokens : 1000;

            // Update temperature display
            temperatureValueSpan.textContent = temperatureSlider.value;

            // Apply API key visibility preference if any, otherwise default to password
            if (apiKeyInput.type === 'text') { // If previously shown
                showApiKeyCheckbox.checked = true;
            } else {
                showApiKeyCheckbox.checked = false;
            }
        }

        /**
         * Saves current chat history to localStorage.
         */
        function saveChatHistory() {
            localStorage.setItem('chatHistory', JSON.stringify(chatHistory));
            updateMessageCount();
        }

        /**
         * Loads chat history from localStorage and displays it.
         */
        function loadChatHistory() {
            const storedHistory = JSON.parse(localStorage.getItem('chatHistory'));
            if (storedHistory) {
                chatHistory = storedHistory;
                chatHistory.forEach(msg => displayMessage(msg.type, msg.text, msg.timestamp, false)); // Don't save again
                chatMessagesDiv.scrollTop = chatMessagesDiv.scrollHeight; // Scroll to bottom
            }
            updateMessageCount();
        }

        // --- UI Update Functions ---

        /**
         * Updates the character count display for the user input textarea.
         */
        function updateCharCount() {
            const currentLength = userInputTextarea.value.length;
            const remaining = MAX_USER_INPUT_CHARS - currentLength;
            charCountSpan.textContent = remaining;
            charCountSpan.style.color = remaining < 200 ? 'orange' : (remaining < 50 ? 'red' : '#888');
        }

        /**
         * Updates the total message count display.
         */
        function updateMessageCount() {
            messageCountSpan.textContent = `Messages: ${chatHistory.length}`;
        }

        /**
         * Displays a message in the chat interface.
         * @param {string} type 'user' or 'bot'.
         * @param {string} text The message text.
         * @param {string} timestamp Optional: HH:MM AM/PM string. If not provided, current time is used.
         * @param {boolean} shouldSave Optional: Whether to save this message to chatHistory. Default true.
         */
        function displayMessage(type, text, timestamp = null, shouldSave = true) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message', `${type}-message`);

            const currentTime = timestamp || formatTime(new Date());
            const contentSpan = document.createElement('span');
            contentSpan.textContent = text;

            const timeSpan = document.createElement('span');
            timeSpan.classList.add('timestamp');
            timeSpan.textContent = currentTime;

            if (type === 'bot') {
                messageDiv.appendChild(contentSpan); // Content first
                messageDiv.appendChild(timeSpan);    // Then timestamp
                const copyBtn = document.createElement('button');
                copyBtn.classList.add('copy-btn');
                copyBtn.textContent = 'Copy';
                copyBtn.onclick = () => copyTextToClipboard(text);
                messageDiv.appendChild(copyBtn);
            } else {
                messageDiv.appendChild(contentSpan); // Content first
                messageDiv.appendChild(timeSpan);    // Then timestamp
            }

            chatMessagesDiv.appendChild(messageDiv);
            chatMessagesDiv.scrollTop = chatMessagesDiv.scrollHeight; // Auto-scroll to bottom

            if (shouldSave) {
                chatHistory.push({ type, text, timestamp: currentTime });
                saveChatHistory();
            }
        }

        // --- Chatbot Core Logic ---

        /**
         * Sends the user's message to the Gemini API and displays the response.
         */
        async function sendMessage() {
            const userMessage = userInputTextarea.value.trim();
            const apiKey = apiKeyInput.value.trim();

            if (!apiKey) {
                alert('Please enter your Gemini API Key!');
                return;
            }
            if (!userMessage) return;

            // Display user message and add to history
            displayMessage('user', userMessage);
            userInputTextarea.value = '';
            updateCharCount();
            sendBtn.disabled = true; // Disable send button during API call

            try {
                const systemPrompt = systemPromptTextarea.value.trim();
                const temperature = parseFloat(temperatureSlider.value);
                const maxTokens = parseInt(maxTokensInput.value);

                const requestBody = {
                    'contents': [{'parts': [{'text': userMessage}]}],
                    'generationConfig': {
                        'temperature': temperature,
                        'maxOutputTokens': maxTokens
                    }
                };

                if (systemPrompt) {
                    requestBody.systemInstruction = {'parts': [{'text': systemPrompt}]};
                }

                const response = await fetch(`${GEMINI_API_URL}?key=${apiKey}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    console.error('API Error:', errorData);
                    throw new Error(`API error: ${response.status} - ${errorData.error?.message || 'Unknown error'}`);
                }

                const data = await response.json();
                const botResponse = data.candidates && data.candidates[0] && data.candidates[0].content && data.candidates[0].content.parts[0] && data.candidates[0].content.parts[0].text
                                    ? data.candidates[0].content.parts[0].text
                                    : 'No response from bot.';
                displayMessage('bot', botResponse);

            } catch (error) {
                console.error('Error sending message:', error);
                displayMessage('bot', `Error: ${error.message || 'Could not get a response.'}`);
            } finally {
                sendBtn.disabled = false; // Re-enable send button
            }
        }

        // --- Event Listeners ---

        document.addEventListener('DOMContentLoaded', () => {
            loadSettings();
            loadChatHistory();
            updateCharCount(); // Initialize char count
            updateMessageCount(); // Initialize message count
            userInputTextarea.focus(); // Focus on input field on load
        });

        // API Key input change listener
        apiKeyInput.addEventListener('input', saveSettings);

        // Show/Hide API Key functionality
        showApiKeyCheckbox.addEventListener('change', () => {
            apiKeyInput.type = showApiKeyCheckbox.checked ? 'text' : 'password';
        });

        // Settings Panel toggle
        settingsPanelToggle.addEventListener('click', () => {
            const isHidden = settingsPanel.style.display === 'none';
            settingsPanel.style.display = isHidden ? 'block' : 'none';
            toggleIcon.innerHTML = isHidden ? '&#9650;' : '&#9660;'; // Change arrow direction
        });

        // System Prompt persistence
        systemPromptTextarea.addEventListener('input', saveSettings);

        // Temperature slider persistence and display update
        temperatureSlider.addEventListener('input', () => {
            temperatureValueSpan.textContent = temperatureSlider.value;
            saveSettings();
        });

        // Max Output Tokens persistence and validation
        maxTokensInput.addEventListener('input', () => {
            let value = parseInt(maxTokensInput.value);
            if (isNaN(value) || value < 100) {
                value = 100;
            } else if (value > 8192) {
                value = 8192;
            }
            maxTokensInput.value = value;
            saveSettings();
        });

        // User input and Send button
        sendBtn.addEventListener('click', sendMessage);
        userInputTextarea.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault(); // Prevent new line
                sendMessage();
            }
        });
        userInputTextarea.addEventListener('input', updateCharCount);

        // Chat Management: Clear Chat
        clearChatBtn.addEventListener('click', () => {
            if (confirm('Are you sure you want to clear all chat messages? This cannot be undone.')) {
                chatHistory = [];
                localStorage.removeItem('chatHistory');
                chatMessagesDiv.innerHTML = '';
                updateMessageCount();
            }
        });

        // Chat Management: Export Chat
        exportChatBtn.addEventListener('click', () => {
            const chatData = {
                timestamp: new Date().toISOString(),
                settings: JSON.parse(localStorage.getItem('chatSettings')),
                history: chatHistory
            };
            const filename = `gemini_chat_export_${new Date().toISOString().replace(/[:.]/g, '-')}.json`;
            const blob = new Blob([JSON.stringify(chatData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        });

    </script>
</body>
</html>